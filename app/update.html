<!DOCTYPE html>
<html>
<head>
    <title>蛐蛐</title>
    <meta content="text/html" charset="utf-8">
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://cdn.bootcss.com/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<body>
    <h>update info</h>
    <div>
        <ul>
            <li>更新1</li>
            <li>更新2</li>
        </ul>
    </div>
    <div>
        <input type="button" value="取消" id="cancel" onclick="cancel()" />
        <input style="margin-left:10px" type="button" value="确定" id="ok" onclick="update()" />
    </div>
    <div style="width:90%;">
        <div class="progress progress-striped active" id="downprocess" style="display:none">
            <div class="progress-bar progress-bar-success" role="progressbar"
                 aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"
                 style="width: 0%;">
                <span class="sr-only">完成</span>
            </div>
        </div>
    </div>
    <script>
        var gui = require('nw.gui');
        var pkg = require('./package.json'); // Insert your app's manifest here
        var updater = require('node-webkit-updater');
        var upd = new updater(pkg);

        function cancel() {
            var currentWin = gui.Window.get();
            currentWin.close(true);
        }

        function update() {
            upd.checkNewVersion(function (error, newVersionExists, manifest) {
                if (!error && newVersionExists) {
                    $('#downprocess').show();
                    var i = 0;
                    var downTimer = setInterval(function () {
                        i++;
                        if (i < 90)
                            $('.progress-bar').attr('style', 'width:' + i + '%');
                        else
                            clearInterval(downTimer);
                    }, 1 * 1000);

                    upd.download(function (error, filename) {
                        console.log("download err:" + error);
                        if (!error) {
                            var mainWindow = process.mainModule.exports.mainWindow;
                            if (!mainWindow.window.confirmUpdate) {
                                return;
                            }
                            mainWindow.window.confirmUpdate(function (up) {
                                console.log(up);
                                if (!up) {
                                    return;
                                }
                                $('.progress-bar').attr('style', 'width:100%');
                                clearInterval(downTimer);
                                if (process.platform == "win32") {
                                    filename = filename.replace(/\\/g, "/");
                                    gui.Shell.openItem(filename);
                                    console.log('update install...');
                                    //gui.App.quit();
                                } else {
                                    console.log("run installer");
                                    upd.unpack(filename, function (error, newAppPath) {
                                        if (!error) {
                                            console.log("unpacked:" + newAppPath);
                                            upd.runInstaller(newAppPath, [upd.getAppPath(), upd.getAppExec()], {});
                                            gui.App.quit();
                                        }
                                    }, manifest);
                                }
                            });
                        }
                    }, manifest);
                }
            });
        }
    </script>
</body>
</html>
